<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Canvas Editor</title>
    <script src="https://art009bas.github.io/reestr/tailwind.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        .canvas-container {
            position: relative;
            overflow: hidden;
            background-image: 
                linear-gradient(45deg, #f0f0f0 25%, transparent 25%),
                linear-gradient(-45deg, #f0f0f0 25%, transparent 25%),
                linear-gradient(45deg, transparent 75%, #f0f0f0 75%),
                linear-gradient(-45deg, transparent 75%, #f0f0f0 75%);
            background-size: 20px 20px;
            background-position: 0 0, 0 10px, 10px -10px, -10px 0px;
        }
        
        .canvas-grid {
            background-image: linear-gradient(#ddd 1px, transparent 1px),
                              linear-gradient(90deg, #ddd 1px, transparent 1px);
            background-size: 20px 20px;
        }
        
        .element {
            position: absolute;
            cursor: move;
            user-select: none;
        }
        
        .element.selected {
            outline: 2px dashed #3b82f6;
        }
        
        .element-group {
            position: absolute;
            border: 1px dashed #999;
            background-color: rgba(59, 130, 246, 0.1);
        }
        
        .resize-handle {
            position: absolute;
            width: 8px;
            height: 8px;
            background-color: white;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            z-index: 10;
        }
        
        .rotate-handle {
            position: absolute;
            width: 16px;
            height: 16px;
            top: -24px;
            left: 50%;
            transform: translateX(-50%);
            background-color: white;
            border: 2px solid #3b82f6;
            border-radius: 50%;
            cursor: grab;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .rotate-handle i {
            color: #3b82f6;
            font-size: 10px;
        }
        
        .tooltip {
            position: absolute;
            background: #333;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 12px;
            z-index: 100;
            pointer-events: none;
            opacity: 0;
            transition: opacity 0.2s;
        }
        
        .tool-btn:hover .tooltip {
            opacity: 1;
        }
        
        .layer-item.selected {
            background-color: #e0e7ff;
        }
        
        .shape-preview {
            width: 24px;
            height: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        @media (max-width: 768px) {
            .toolbar-icon {
                padding: 0.25rem;
            }
            .property-panel {
                position: fixed;
                bottom: 0;
                left: 0;
                right: 0;
                height: 200px;
                overflow-y: auto;
            }
        }
        
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        
        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: 4px;
        }
        
        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }
    </style>
</head>
<body class="bg-gray-100 font-sans flex flex-col h-screen">
    <!-- Top Toolbar -->
    <div class="bg-white shadow-md px-4 py-2 flex items-center justify-between">
        <div class="flex items-center space-x-4">
            <h1 class="text-xl font-bold text-blue-600">Advanced Canvas Editor</h1>
            <div class="flex space-x-2">
                <button id="new-project" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded flex items-center">
                    <i class="fas fa-file mr-2"></i> New
                </button>
                <button id="save-project" class="px-3 py-1 bg-blue-100 hover:bg-blue-200 text-blue-700 rounded flex items-center">
                    <i class="fas fa-save mr-2"></i> Save
                </button>
                <div class="relative">
                    <button id="export-btn" class="px-3 py-1 bg-green-100 hover:bg-green-200 text-green-700 rounded flex items-center">
                        <i class="fas fa-download mr-2"></i> Export
                    </button>
                    <div id="export-menu" class="hidden absolute left-0 mt-1 w-40 bg-white shadow-lg rounded-md z-10">
                        <button class="export-option block w-full text-left px-4 py-2 hover:bg-gray-100" data-type="png">PNG</button>
                        <button class="export-option block w-full text-left px-4 py-2 hover:bg-gray-100" data-type="jpeg">JPEG</button>
                        <button class="export-option block w-full text-left px-4 py-2 hover:bg-gray-100" data-type="json">JSON</button>
                        <button class="export-option block w-full text-left px-4 py-2 hover:bg-gray-100" data-type="pdf">PDF</button>
                        <button class="export-option block w-full text-left px-4 py-2 hover:bg-gray-100" data-type="svg">SVG</button>
                    </div>
                </div>
            </div>
        </div>
        <div class="flex items-center space-x-4">
            <button id="undo-btn" class="p-2 text-gray-600 hover:text-gray-900" title="Undo (Ctrl+Z)">
                <i class="fas fa-undo"></i>
            </button>
            <button id="redo-btn" class="p-2 text-gray-600 hover:text-gray-900" title="Redo (Ctrl+Shift+Z)">
                <i class="fas fa-redo"></i>
            </button>
            <div class="flex items-center">
                <button id="zoom-out" class="p-2 text-gray-600 hover:text-gray-900">
                    <i class="fas fa-search-minus"></i>
                </button>
                <span id="zoom-level" class="mx-2 text-sm">100%</span>
                <button id="zoom-in" class="p-2 text-gray-600 hover:text-gray-900">
                    <i class="fas fa-search-plus"></i>
                </button>
            </div>
            <div class="relative">
                <button id="canvas-size" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded flex items-center">
                    <i class="fas fa-expand mr-2"></i> 800x600
                </button>
                <div id="size-menu" class="hidden absolute right-0 mt-1 w-48 bg-white shadow-lg rounded-md z-10">
                    <div class="px-4 py-2 font-medium text-gray-700">Presets</div>
                    <button class="size-option block w-full text-left px-4 py-2 hover:bg-gray-100" data-width="1080" data-height="1080">Instagram Post (1080x1080)</button>
                    <button class="size-option block w-full text-left px-4 py-2 hover:bg-gray-100" data-width="1280" data-height="720">YouTube Thumbnail (1280x720)</button>
                    <button class="size-option block w-full text-left px-4 py-2 hover:bg-gray-100" data-width="800" data-height="600">Default (800x600)</button>
                    <div class="border-t border-gray-200 px-4 py-2">
                        <div class="text-sm font-medium text-gray-700 mb-1">Custom Size</div>
                        <div class="flex space-x-2">
                            <input type="number" id="custom-width" class="w-16 px-2 py-1 border rounded" placeholder="Width" value="800">
                            <span class="flex items-center">x</span>
                            <input type="number" id="custom-height" class="w-16 px-2 py-1 border rounded" placeholder="Height" value="600">
                        </div>
                        <button id="apply-custom-size" class="mt-2 w-full px-2 py-1 bg-blue-500 text-white rounded hover:bg-blue-600">Apply</button>
                    </div>
                </div>
            </div>
            <button id="toggle-snap" class="px-3 py-1 bg-gray-200 hover:bg-gray-300 rounded flex items-center">
                <i class="fas fa-magnet mr-2"></i> Snap
            </button>
        </div>
    </div>

    <!-- Main Content -->
    <div class="flex flex-1 overflow-hidden">
        <!-- Left Sidebar - Tools -->
        <div class="w-16 bg-white shadow-md flex flex-col items-center py-4 space-y-4">
            <div class="relative">
                <button class="tool-btn active" data-tool="select" title="Select (V)">
                    <i class="fas fa-mouse-pointer text-blue-600"></i>
                    <div class="tooltip">Select (V)</div>
                </button>
            </div>
            
            <div class="relative">
                <button class="tool-btn" data-tool="text" title="Text (T)">
                    <i class="fas fa-font"></i>
                    <div class="tooltip">Text (T)</div>
                </button>
            </div>
            
            <div class="relative">
                <button class="tool-btn" data-tool="image" title="Image (I)">
                    <i class="fas fa-image"></i>
                    <div class="tooltip">Image (I)</div>
                </button>
            </div>
            
            <div class="relative group">
                <button class="tool-btn" data-tool="shape" title="Shapes (S)">
                    <i class="fas fa-square"></i>
                    <div class="tooltip">Shapes (S)</div>
                </button>
                <div class="hidden group-hover:block absolute left-full ml-2 top-0 w-48 bg-white shadow-lg rounded-md z-10">
                    <button class="shape-option block w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center" data-shape="rectangle">
                        <div class="shape-preview mr-2"><div style="width:16px;height:16px;background:#3b82f6;"></div></div>
                        Rectangle
                    </button>
                    <button class="shape-option block w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center" data-shape="circle">
                        <div class="shape-preview mr-2"><div style="width:16px;height:16px;background:#3b82f6;border-radius:50%;"></div></div>
                        Circle
                    </button>
                    <button class="shape-option block w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center" data-shape="triangle">
                        <div class="shape-preview mr-2"><div style="width:0;height:0;border-left:8px solid transparent;border-right:8px solid transparent;border-bottom:16px solid #3b82f6;"></div></div>
                        Triangle
                    </button>
                    <button class="shape-option block w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center" data-shape="line">
                        <div class="shape-preview mr-2"><div style="width:16px;height:2px;background:#3b82f6;margin-top:7px;"></div></div>
                        Line
                    </button>
                    <button class="shape-option block w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center" data-shape="star">
                        <div class="shape-preview mr-2"><i class="fas fa-star text-yellow-400"></i></div>
                        Star
                    </button>
                    <button class="shape-option block w-full text-left px-4 py-2 hover:bg-gray-100 flex items-center" data-shape="hexagon">
                        <div class="shape-preview mr-2"><i class="fas fa-hexagon text-purple-500"></i></div>
                        Hexagon
                    </button>
                </div>
            </div>
            
            <div class="relative">
                <button class="tool-btn" data-tool="icon" title="Icons">
                    <i class="fas fa-icons"></i>
                    <div class="tooltip">Icons</div>
                </button>
            </div>
            
            <div class="border-t border-gray-200 w-8 mx-auto my-2"></div>
            
            <div class="relative">
                <button class="tool-btn" data-tool="move" title="Move Canvas (H)">
                    <i class="fas fa-hand-paper"></i>
                    <div class="tooltip">Move Canvas (H)</div>
                </button>
            </div>
            
            <div class="relative">
                <button id="toggle-grid" class="tool-btn" title="Toggle Grid (G)">
                    <i class="fas fa-th"></i>
                    <div class="tooltip">Toggle Grid (G)</div>
                </button>
            </div>
            
            <div class="relative">
                <button id="toggle-rulers" class="tool-btn" title="Toggle Rulers (R)">
                    <i class="fas fa-ruler-combined"></i>
                    <div class="tooltip">Toggle Rulers (R)</div>
                </button>
            </div>
            
            <div class="border-t border-gray-200 w-8 mx-auto my-2"></div>
            
            <div class="relative">
                <button id="group-btn" class="tool-btn" title="Group (Ctrl+G)">
                    <i class="fas fa-object-group"></i>
                    <div class="tooltip">Group (Ctrl+G)</div>
                </button>
            </div>
            
            <div class="relative">
                <button id="ungroup-btn" class="tool-btn" title="Ungroup (Ctrl+Shift+G)">
                    <i class="fas fa-object-ungroup"></i>
                    <div class="tooltip">Ungroup (Ctrl+Shift+G)</div>
                </button>
            </div>
        </div>

        <!-- Canvas Area -->
        <div class="flex-1 relative overflow-auto">
            <div id="canvas-container" class="canvas-container mx-auto bg-white shadow-lg relative">
                <div id="canvas-rulers" class="hidden absolute top-0 left-0 right-0 h-8 bg-gray-100 border-b border-gray-300">
                    <!-- Horizontal ruler marks will be added here -->
                </div>
                <div id="canvas-ruler-vertical" class="hidden absolute top-0 left-0 bottom-0 w-8 bg-gray-100 border-r border-gray-300">
                    <!-- Vertical ruler marks will be added here -->
                </div>
                <div id="canvas" class="canvas-grid relative" style="width: 800px; height: 600px;">
                    <!-- Elements will be added here -->
                </div>
                <div id="canvas-overlay" class="absolute inset-0 pointer-events-none"></div>
            </div>
        </div>

        <!-- Right Sidebar - Properties and Layers -->
        <div class="flex">
            <!-- Layers Panel -->
            <div id="layers-panel" class="w-48 bg-white shadow-md overflow-y-auto p-4 border-r border-gray-200">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Layers</h3>
                    <button id="toggle-layers" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-layer-group"></i>
                    </button>
                </div>
                
                <div id="layers-list" class="space-y-1">
                    <!-- Layers will be added here dynamically -->
                </div>
                
                <div class="mt-4 pt-4 border-t border-gray-200">
                    <button id="add-layer" class="w-full px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded">
                        <i class="fas fa-plus mr-1"></i> Add Layer
                    </button>
                </div>
            </div>
            
            <!-- Properties Panel -->
            <div id="property-panel" class="w-64 bg-white shadow-md overflow-y-auto p-4">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="font-bold text-lg">Properties</h3>
                    <button id="close-properties" class="text-gray-500 hover:text-gray-700">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                
                <div id="element-properties">
                    <!-- Properties will be added here dynamically -->
                </div>
            </div>
        </div>
    </div>

    <!-- Bottom Status Bar -->
    <div class="bg-gray-800 text-white px-4 py-2 flex justify-between items-center text-sm">
        <div class="flex space-x-4">
            <span id="cursor-position">X: 0, Y: 0</span>
            <span id="selected-element">No element selected</span>
            <span id="snap-status">Snap: Off</span>
        </div>
        <div>
            <span id="zoom-status">Zoom: 100%</span>
        </div>
    </div>

    <!-- Hidden file inputs -->
    <input type="file" id="image-upload" accept="image/*" class="hidden">
    <input type="file" id="background-upload" accept="image/*" class="hidden">

    <!-- Modals -->
    <div id="new-project-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <!-- Modal content -->
    </div>

    <div id="icon-modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <!-- Modal content -->
    </div>

    <script>
        // Enhanced state management
        const state = {
            currentTool: 'select',
            selectedElement: null,
            selectedElements: [],
            elements: [],
            groups: [],
            layers: [
                { id: 'layer-1', name: 'Layer 1', visible: true, locked: false, order: 0 }
            ],
            activeLayer: 'layer-1',
            zoom: 1,
            canvasWidth: 800,
            canvasHeight: 600,
            history: [],
            historyIndex: -1,
            isDragging: false,
            isResizing: false,
            isRotating: false,
            isMovingCanvas: false,
            dragStartX: 0,
            dragStartY: 0,
            initialElementX: 0,
            initialElementY: 0,
            initialElementWidth: 0,
            initialElementHeight: 0,
            initialRotation: 0,
            resizeHandle: null,
            snapToGrid: false,
            snapToObjects: true,
            showGrid: false,
            showRulers: false,
            nextId: 1,
            nextGroupId: 1,
            nextLayerId: 2
        };

        // DOM elements
        const canvas = document.getElementById('canvas');
        const canvasContainer = document.getElementById('canvas-container');
        const propertyPanel = document.getElementById('property-panel');
        const layersPanel = document.getElementById('layers-panel');
        const layersList = document.getElementById('layers-list');
        const cursorPosition = document.getElementById('cursor-position');
        const selectedElementText = document.getElementById('selected-element');
        const zoomLevel = document.getElementById('zoom-level');
        const zoomStatus = document.getElementById('zoom-status');
        const snapStatus = document.getElementById('snap-status');
        const canvasRulers = document.getElementById('canvas-rulers');
        const canvasRulerVertical = document.getElementById('canvas-ruler-vertical');
        const toggleGridBtn = document.getElementById('toggle-grid');
        const toggleRulersBtn = document.getElementById('toggle-rulers');
        const toggleSnapBtn = document.getElementById('toggle-snap');
        const groupBtn = document.getElementById('group-btn');
        const ungroupBtn = document.getElementById('ungroup-btn');
        const imageUpload = document.getElementById('image-upload');
        const backgroundUpload = document.getElementById('background-upload');
        const newProjectModal = document.getElementById('new-project-modal');
        const iconModal = document.getElementById('icon-modal');
        const iconGrid = document.getElementById('icon-grid');
        const addLayerBtn = document.getElementById('add-layer');

        // Initialize the canvas
        function initCanvas() {
            updateCanvasSize();
            loadProject();
            setupEventListeners();
            updateUI();
            updateLayersList();
        }

        // Set up event listeners
        function setupEventListeners() {
            // Tool buttons
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.tool-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    state.currentTool = this.dataset.tool;
                    
                    if (state.currentTool === 'image') {
                        imageUpload.click();
                    }
                });
            });

            // Shape options
            document.querySelectorAll('.shape-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    addShape(this.dataset.shape);
                });
            });

            // Canvas size options
            document.querySelectorAll('.size-option').forEach(btn => {
                btn.addEventListener('click', function() {
                    state.canvasWidth = parseInt(this.dataset.width);
                    state.canvasHeight = parseInt(this.dataset.height);
                    updateCanvasSize();
                    document.getElementById('canvas-size').textContent = `${state.canvasWidth}x${state.canvasHeight}`;
                    document.getElementById('size-menu').classList.add('hidden');
                });
            });

            // Apply custom size
            document.getElementById('apply-custom-size').addEventListener('click', function() {
                const width = parseInt(document.getElementById('custom-width').value);
                const height = parseInt(document.getElementById('custom-height').value);
                
                if (width > 0 && height > 0) {
                    state.canvasWidth = width;
                    state.canvasHeight = height;
                    updateCanvasSize();
                    document.getElementById('canvas-size').textContent = `${state.canvasWidth}x${state.canvasHeight}`;
                    document.getElementById('size-menu').classList.add('hidden');
                }
            });

            // Canvas events
            canvas.addEventListener('mousedown', handleCanvasMouseDown);
            canvas.addEventListener('mousemove', handleCanvasMouseMove);
            canvas.addEventListener('mouseup', handleCanvasMouseUp);
            canvas.addEventListener('mouseleave', handleCanvasMouseLeave);
            
            // Touch events
            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', handleTouchEnd);

            // Zoom buttons
            document.getElementById('zoom-in').addEventListener('click', zoomIn);
            document.getElementById('zoom-out').addEventListener('click', zoomOut);
            
            // Toggle buttons
            toggleGridBtn.addEventListener('click', toggleGrid);
            toggleRulersBtn.addEventListener('click', toggleRulers);
            toggleSnapBtn.addEventListener('click', toggleSnap);
            
            // Grouping
            groupBtn.addEventListener('click', groupSelectedElements);
            ungroupBtn.addEventListener('click', ungroupSelectedElements);
            
            // Layers
            addLayerBtn.addEventListener('click', addNewLayer);
            
            // Image upload
            imageUpload.addEventListener('change', handleImageUpload);
            backgroundUpload.addEventListener('change', handleBackgroundUpload);
            
            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboardShortcuts);
        }

        // Handle canvas mouse down
        function handleCanvasMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / state.zoom;
            const y = (e.clientY - rect.top) / state.zoom;
            
            if (state.currentTool === 'move') {
                state.isMovingCanvas = true;
                state.dragStartX = e.clientX;
                state.dragStartY = e.clientY;
                return;
            }

            // Check if clicking on a resize handle
            if (state.selectedElement) {
                const element = document.getElementById(state.selectedElement);
                const handles = element.querySelectorAll('.resize-handle');
                
                handles.forEach(handle => {
                    const handleRect = handle.getBoundingClientRect();
                    if (e.clientX >= handleRect.left && e.clientX <= handleRect.right && 
                        e.clientY >= handleRect.top && e.clientY <= handleRect.bottom) {
                        state.isResizing = true;
                        state.resizeHandle = handle.dataset.handle;
                        state.initialElementWidth = parseInt(element.style.width);
                        state.initialElementHeight = parseInt(element.style.height);
                        state.dragStartX = x;
                        state.dragStartY = y;
                        return;
                    }
                });
                
                // Check rotate handle
                const rotateHandle = element.querySelector('.rotate-handle');
                if (rotateHandle) {
                    const handleRect = rotateHandle.getBoundingClientRect();
                    if (e.clientX >= handleRect.left && e.clientX <= handleRect.right && 
                        e.clientY >= handleRect.top && e.clientY <= handleRect.bottom) {
                        state.isRotating = true;
                        state.initialRotation = parseFloat(element.dataset.rotation || 0);
                        const elementRect = element.getBoundingClientRect();
                        const centerX = elementRect.left + elementRect.width / 2;
                        const centerY = elementRect.top + elementRect.height / 2;
                        state.dragStartAngle = Math.atan2(e.clientY - centerY, e.clientX - centerX) * (180 / Math.PI);
                        return;
                    }
                }
            }
            
            if (!state.isResizing && !state.isRotating) {
                const clickedElement = findElementAtPosition(x, y);
                
                if (clickedElement) {
                    // Multi-select with Shift key
                    if (e.shiftKey) {
                        if (state.selectedElements.includes(clickedElement.id)) {
                            state.selectedElements = state.selectedElements.filter(id => id !== clickedElement.id);
                            clickedElement.classList.remove('selected');
                        } else {
                            state.selectedElements.push(clickedElement.id);
                            clickedElement.classList.add('selected');
                        }
                        state.selectedElement = clickedElement.id;
                    } else {
                        // Single select
                        deselectAllElements();
                        selectElement(clickedElement.id);
                    }
                    
                    state.isDragging = true;
                    state.dragStartX = x;
                    state.dragStartY = y;
                    state.initialElementX = parseInt(clickedElement.style.left);
                    state.initialElementY = parseInt(clickedElement.style.top);
                } else {
                    deselectAllElements();
                    
                    if (state.currentTool === 'text') {
                        addTextElement(x, y);
                    } else if (state.currentTool === 'shape') {
                        addShape('rectangle', x, y);
                    } else if (state.currentTool === 'icon') {
                        showIconModal(x, y);
                    }
                }
            }
            
            e.preventDefault();
        }

        // Handle canvas mouse move
        function handleCanvasMouseMove(e) {
            const rect = canvas.getBoundingClientRect();
            const x = (e.clientX - rect.left) / state.zoom;
            const y = (e.clientY - rect.top) / state.zoom;
            
            cursorPosition.textContent = `X: ${Math.round(x)}, Y: ${Math.round(y)}`;
            
            if (state.isMovingCanvas) {
                const dx = e.clientX - state.dragStartX;
                const dy = e.clientY - state.dragStartY;
                canvasContainer.scrollLeft -= dx;
                canvasContainer.scrollTop -= dy;
                state.dragStartX = e.clientX;
                state.dragStartY = e.clientY;
                return;
            }
            
            if (state.isDragging && state.selectedElement) {
                const dx = x - state.dragStartX;
                const dy = y - state.dragStartY;
                
                let newX = state.initialElementX + dx;
                let newY = state.initialElementY + dy;
                
                // Snap to grid
                if (state.snapToGrid) {
                    newX = Math.round(newX / 10) * 10;
                    newY = Math.round(newY / 10) * 10;
                }
                
                // Snap to objects
                if (state.snapToObjects) {
                    const snapThreshold = 10;
                    let snapX = null, snapY = null;
                    
                    state.elements.forEach(el => {
                        if (el.id === state.selectedElement) return;
                        
                        const element = document.getElementById(el.id);
                        if (!element) return;
                        
                        const elX = parseInt(element.style.left);
                        const elY = parseInt(element.style.top);
                        const elWidth = parseInt(element.style.width);
                        const elHeight = parseInt(element.style.height);
                        
                        // Check for snap points (edges and centers)
                        const snapPoints = [
                            { x: elX, y: elY }, // top-left
                            { x: elX + elWidth/2, y: elY }, // top-center
                            { x: elX + elWidth, y: elY }, // top-right
                            { x: elX, y: elY + elHeight/2 }, // middle-left
                            { x: elX + elWidth/2, y: elY + elHeight/2 }, // center
                            { x: elX + elWidth, y: elY + elHeight/2 }, // middle-right
                            { x: elX, y: elY + elHeight }, // bottom-left
                            { x: elX + elWidth/2, y: elY + elHeight }, // bottom-center
                            { x: elX + elWidth, y: elY + elHeight } // bottom-right
                        ];
                        
                        snapPoints.forEach(point => {
                            if (Math.abs(newX - point.x) < snapThreshold) snapX = point.x;
                            if (Math.abs(newY - point.y) < snapThreshold) snapY = point.y;
                        });
                    });
                    
                    if (snapX !== null) newX = snapX;
                    if (snapY !== null) newY = snapY;
                }
                
                // Move single element
                const element = document.getElementById(state.selectedElement);
                if (element) {
                    element.style.left = `${newX}px`;
                    element.style.top = `${newY}px`;
                }
                
                // Move multiple selected elements
                if (state.selectedElements.length > 1) {
                    state.selectedElements.forEach(id => {
                        if (id === state.selectedElement) return;
                        const el = document.getElementById(id);
                        if (el) {
                            const initialX = parseInt(el.dataset.initialX || el.style.left);
                            const initialY = parseInt(el.dataset.initialY || el.style.top);
                            el.style.left = `${initialX + dx}px`;
                            el.style.top = `${initialY + dy}px`;
                        }
                    });
                }
                
                updatePropertyPanel();
            }
            
            if (state.isResizing && state.selectedElement) {
                // ... (existing resize code)
            }
            
            if (state.isRotating && state.selectedElement) {
                // ... (existing rotate code)
            }
        }

        // Group selected elements
        function groupSelectedElements() {
            if (state.selectedElements.length < 2) return;
            
            const groupId = `group-${state.nextGroupId++}`;
            const elements = state.selectedElements.map(id => document.getElementById(id));
            
            // Calculate group bounds
            let minX = Infinity, minY = Infinity, maxX = -Infinity, maxY = -Infinity;
            elements.forEach(el => {
                const x = parseInt(el.style.left);
                const y = parseInt(el.style.top);
                const width = parseInt(el.style.width);
                const height = parseInt(el.style.height);
                
                minX = Math.min(minX, x);
                minY = Math.min(minY, y);
                maxX = Math.max(maxX, x + width);
                maxY = Math.max(maxY, y + height);
            });
            
            // Create group container
            const group = document.createElement('div');
            group.id = groupId;
            group.className = 'element-group';
            group.style.left = `${minX}px`;
            group.style.top = `${minY}px`;
            group.style.width = `${maxX - minX}px`;
            group.style.height = `${maxY - minY}px`;
            group.dataset.type = 'group';
            group.dataset.elements = JSON.stringify(state.selectedElements);
            
            // Reposition elements relative to group
            elements.forEach(el => {
                const x = parseInt(el.style.left) - minX;
                const y = parseInt(el.style.top) - minY;
                el.style.position = 'relative';
                el.style.left = `${x}px`;
                el.style.top = `${y}px`;
                el.dataset.group = groupId;
                group.appendChild(el);
            });
            
            // Add group to canvas
            canvas.appendChild(group);
            
            // Update state
            state.groups.push({
                id: groupId,
                elements: state.selectedElements
            });
            
            // Select the group
            deselectAllElements();
            selectElement(groupId);
            
            saveToHistory();
        }

        // Ungroup selected elements
        function ungroupSelectedElements() {
            if (!state.selectedElement) return;
            
            const group = document.getElementById(state.selectedElement);
            if (!group || group.dataset.type !== 'group') return;
            
            const elements = JSON.parse(group.dataset.elements);
            const groupX = parseInt(group.style.left);
            const groupY = parseInt(group.style.top);
            
            // Move elements back to canvas and update their positions
            elements.forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const x = parseInt(el.style.left) + groupX;
                    const y = parseInt(el.style.top) + groupY;
                    
                    el.style.position = 'absolute';
                    el.style.left = `${x}px`;
                    el.style.top = `${y}px`;
                    delete el.dataset.group;
                    
                    canvas.appendChild(el);
                }
            });
            
            // Remove group from state and DOM
            state.groups = state.groups.filter(g => g.id !== state.selectedElement);
            group.remove();
            
            // Select first element from the group
            if (elements.length > 0) {
                selectElement(elements[0]);
            }
            
            saveToHistory();
        }

        // Add new layer
        function addNewLayer() {
            const layerId = `layer-${state.nextLayerId++}`;
            const layerName = `Layer ${state.nextLayerId - 1}`;
            
            state.layers.push({
                id: layerId,
                name: layerName,
                visible: true,
                locked: false,
                order: state.layers.length
            });
            
            updateLayersList();
            saveToHistory();
        }

        // Update layers list UI
        function updateLayersList() {
            layersList.innerHTML = '';
            
            // Sort layers by order (reverse for display)
            const sortedLayers = [...state.layers].sort((a, b) => b.order - a.order);
            
            sortedLayers.forEach(layer => {
                const layerItem = document.createElement('div');
                layerItem.className = `layer-item flex items-center justify-between p-2 rounded ${state.activeLayer === layer.id ? 'selected' : ''}`;
                layerItem.dataset.layerId = layer.id;
                
                layerItem.innerHTML = `
                    <div class="flex items-center">
                        <button class="layer-visibility mr-2 text-gray-500 hover:text-gray-700">
                            <i class="fas ${layer.visible ? 'fa-eye' : 'fa-eye-slash'}"></i>
                        </button>
                        <span class="layer-name truncate">${layer.name}</span>
                    </div>
                    <div>
                        <button class="layer-lock text-gray-500 hover:text-gray-700">
                            <i class="fas ${layer.locked ? 'fa-lock' : 'fa-unlock'}"></i>
                        </button>
                    </div>
                `;
                
                layerItem.addEventListener('click', () => {
                    state.activeLayer = layer.id;
                    updateLayersList();
                });
                
                // Toggle visibility
                layerItem.querySelector('.layer-visibility').addEventListener('click', (e) => {
                    e.stopPropagation();
                    layer.visible = !layer.visible;
                    updateLayersList();
                    saveToHistory();
                });
                
                // Toggle lock
                layerItem.querySelector('.layer-lock').addEventListener('click', (e) => {
                    e.stopPropagation();
                    layer.locked = !layer.locked;
                    updateLayersList();
                    saveToHistory();
                });
                
                layersList.appendChild(layerItem);
            });
        }

        // Toggle snap
        function toggleSnap() {
            state.snapToGrid = !state.snapToGrid;
            updateUI();
            saveToHistory();
        }

        // Update UI
        function updateUI() {
            // Update tool buttons
            document.querySelectorAll('.tool-btn').forEach(btn => {
                btn.classList.remove('active');
                if (btn.dataset.tool === state.currentTool) {
                    btn.classList.add('active');
                }
            });
            
            // Update toggle buttons
            toggleGridBtn.classList.toggle('text-blue-600', state.showGrid);
            toggleRulersBtn.classList.toggle('text-blue-600', state.showRulers);
            toggleSnapBtn.classList.toggle('text-blue-600', state.snapToGrid);
            
            // Update status
            snapStatus.textContent = `Snap: ${state.snapToGrid ? 'On' : 'Off'}`;
        }

        // Initialize the app
        window.addEventListener('DOMContentLoaded', initCanvas);
    </script>
</body>
</html>
